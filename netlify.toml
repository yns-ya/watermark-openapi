[build]
  # Frozen install (requires clean, committed pnpm-lock.yaml)
  command = "pnpm install"
  publish = "public"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "18"
  # For pnpm, use PNPM_FLAGS. Skip optional native addons and dev deps.
  PNPM_FLAGS = "--prod --no-optional"


[functions]
  node_bundler = "esbuild"
  external_node_modules = ["sharp"]
  included_files = ["src/assets/**/*"]

# Context-specific environment overrides
[context.production.environment]
  NODE_ENV = "production"
  # It's recommended to set JWT_SECRET in Netlify UI, not here
  MAX_FILE_SIZE = "6291456"        # 6MB (Netlify free tier limit)
  MAX_IMAGE_WIDTH = "4096"
  MAX_IMAGE_HEIGHT = "4096"

[context.deploy-preview.environment]
  NODE_ENV = "preview"
  MAX_FILE_SIZE = "6291456"
  MAX_IMAGE_WIDTH = "4096"
  MAX_IMAGE_HEIGHT = "4096"

[context.branch-deploy.environment]
  NODE_ENV = "development"
  MAX_FILE_SIZE = "6291456"
  MAX_IMAGE_WIDTH = "4096"
  MAX_IMAGE_HEIGHT = "4096"

# Redirect all calls to the watermark function (Monolith style)
[[redirects]]
  from = "/*"
  to = "/.netlify/functions/watermark"
  status = 200

[dev]
  port = 8888
  publish = "public"
  autoLaunch = false
